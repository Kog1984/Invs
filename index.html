<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>INVS Squad Submission</title>
<style>
  body {
    font-family: sans-serif;
    background: #121212;
    color: white;
    max-width: 480px;
    margin: 2rem auto;
    padding: 1rem;
  }
  input, button {
    width: 100%;
    padding: 0.75rem;
    margin-top: 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
  }
  input {
    background: #222;
    color: white;
  }
  button {
    background: #28a745;
    color: white;
    cursor: pointer;
  }
  .success {
    margin-top: 1rem;
    color: #0f0;
  }
  .error {
    margin-top: 1rem;
    color: #f44;
  }
</style>
</head>
<body>

<h1>Submit Your Squad Power</h1>

<form id="submitForm" autocomplete="off">
  <input id="name" type="text" placeholder="Your Name" required />
  <input id="squadPower" type="text" placeholder="Squad Power (e.g. 32.5M or 34500000)" required />
  <button type="submit">Submit</button>
</form>

<div id="message"></div>

<script>
  const form = document.getElementById('submitForm');
  const nameInput = document.getElementById('name');
  const powerInput = document.getElementById('squadPower');
  const messageDiv = document.getElementById('message');
  const submitButton = form.querySelector('button');

  // Load saved name from localStorage
  window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem('inv_username');
    if (savedName) {
      nameInput.value = savedName;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.textContent = '';
    messageDiv.className = '';

    // Normalize and prepare inputs
    const rawName = nameInput.value;
    const name = rawName.trim().toLowerCase();
    let rawPower = powerInput.value.trim().replace(',', '.'); // replace comma decimal with dot

    // Parse float from input - remove "M" or "m" if present and multiply by 1 million
    let multiplier = 1;
    if (/m$/i.test(rawPower)) {
      multiplier = 1_000_000;
      rawPower = rawPower.slice(0, -1);
    }
    const squadPower = parseFloat(rawPower) * multiplier;

    if (!name || isNaN(squadPower) || squadPower <= 0) {
      messageDiv.textContent = '❌ Invalid name or squad power.';
      messageDiv.className = 'error';
      return;
    }

    // Disable form controls during submission
    nameInput.disabled = true;
    powerInput.disabled = true;
    submitButton.disabled = true;

    // Save username locally
    localStorage.setItem('inv_username', rawName);

    // Prepare data to send (send original name case for display, but key matching uses lowercase)
    const data = { name, squadPower };

    try {
      const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}`);
      }

      messageDiv.textContent = '✅ Submitted successfully!';
      messageDiv.className = 'success';

      // Clear squad power input but keep name for convenience
      powerInput.value = '';
    } catch (err) {
      console.error('Submission error:', err);
      messageDiv.textContent = '❌ Error submitting. Please try again later.';
      messageDiv.className = 'error';
    }

    // Re-enable form controls
    nameInput.disabled = false;
    powerInput.disabled = false;
    submitButton.disabled = false;
  });
</script>

</body>
</html>
